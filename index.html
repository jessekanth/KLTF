<!DOCTYPE html>
<html lang="en">
<head>
  <title>Church Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --deep-blue: #0a2463;
      --gold: #d4af37;
      --light-blue: #3e92cc;
      --white: #fff;
      --light-gray: #f5f7fa;
      --dark-gray: #333;
      --error-red: #e74c3c;
      --success-green: #2ecc71;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--light-gray);
      color: var(--dark-gray);
      font-size: 14px;
      line-height: 1.5;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: var(--deep-blue);
      color: white;
    }
    .view-toggle {
      display: flex;
      background-color: var(--deep-blue);
      border-radius: 5px;
      overflow: hidden;
      margin: 15px;
    }
    .view-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background-color: var(--deep-blue);
      color: var(--white);
      cursor: pointer;
      transition: 0.2s;
    }
    .view-btn.active {
      background-color: var(--gold);
      color: var(--deep-blue);
    }
    .view-btn:focus {
      outline: 2px solid var(--gold);
      outline-offset: -2px;
    }
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px;
    }
    .card {
      background: var(--white);
      border-radius: 5px;
      padding: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-left: 3px solid var(--gold);
    }
    .card.attendance-card {
      border-left-color: var(--light-blue);
    }
    .card h3 {
      margin: 0 0 5px 0;
      color: var(--deep-blue);
      font-size: 0.9rem;
    }
    .card .value {
      font-size: 1.3rem;
      font-weight: bold;
      margin: 5px 0;
      color: var(--deep-blue);
    }
    .card.attendance-card .value {
      color: var(--light-blue);
    }
    .chart-container {
      background: var(--white);
      border-radius: 5px;
      padding: 15px;
      margin: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    table {
      width: calc(100% - 30px);
      margin: 15px;
      border-collapse: collapse;
      background: var(--white);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-radius: 5px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: var(--deep-blue);
      color: var(--white);
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .loading-container, .error-container {
      text-align: center;
      padding: 40px 20px;
      margin: 15px;
      background: var(--white);
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .loading-spinner {
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 10px;
      animation: spin 1s linear infinite;
    }
    .error-message {
      color: var(--error-red);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    select, button {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: inherit;
    }
    button {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button.primary {
      background-color: var(--gold);
      color: var(--deep-blue);
      border: none;
      font-weight: bold;
    }
    button.primary:hover {
      background-color: #e6c44d;
    }
    button.secondary {
      background-color: var(--light-blue);
      color: white;
      border: none;
    }
    button.secondary:hover {
      background-color: #4a9fd6;
    }
    .input-group {
      margin: 15px;
      display: flex;
      gap: 10px;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    @media (max-width: 768px) {
      .card-container {
        grid-template-columns: 1fr 1fr;
      }
      .input-group {
        flex-direction: column;
      }
    }
    @media (max-width: 480px) {
      .card-container {
        grid-template-columns: 1fr;
      }
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
    }
    /* Reduce pie chart size */
    #pieChart {
      max-height: 300px !important;
    }
    /* Print layout adjustments */
    @media print {
      body {
        background-color: white;
        color: black;
        font-size: 11px;
        margin: 10mm;
      }
      .header, .view-toggle, .input-group, button {
        display: none;
      }
      .chart-container, .card-container, table {
        box-shadow: none;
        margin: 5px 0;
        page-break-inside: avoid;
      }
      .card {
        padding: 6px;
      }
      table {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;font-size:1.2rem;color:var(--gold)">
      <i class="fas fa-church" aria-hidden="true"></i> Church Dashboard
    </h1>
    <button id="printBtn" class="secondary" aria-label="Print dashboard">
      <i class="fas fa-print"></i> Print
    </button>
  </div>
  
  <div class="view-toggle">
    <button class="view-btn active" id="summaryBtn" aria-pressed="true">
      <i class="fas fa-chart-pie" aria-hidden="true"></i> Summary
    </button>
    <button class="view-btn" id="transactionsBtn" aria-pressed="false">
      <i class="fas fa-list" aria-hidden="true"></i> Transactions
    </button>
  </div>

  <!-- Content -->
  <div id="content" style="display:none;">
    <div id="summaryPage">
      <div class="toolbar">
        <div class="input-group">
          <select id="yearSelect" aria-label="Select year"></select>
          <select id="monthSelect" aria-label="Select month">
            <option value="">All Months</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          <button onclick="applyFilters()" class="primary">
            <i class="fas fa-filter"></i> Apply
          </button>
        </div>
      </div>

      <div class="card-container">
        <div class="card attendance-card">
          <h3>Members Attended</h3>
          <div class="value" id="attendanceCount">0</div>
          <div class="subtext">Church Strength (Sunday)</div>
        </div>
        <div class="card">
          <h3>Total Offerings</h3>
          <div class="value" id="totalOfferings">RM0.00</div>
          <div class="subtext" id="offeringPeriod">All Time</div>
        </div>
        <div class="card">
          <h3>Average Offering</h3>
          <div class="value" id="avgOffering">RM0.00</div>
          <div class="subtext" id="avgPeriod">Per service</div>
        </div>
        <div class="card">
          <h3>Services Recorded</h3>
          <div class="value" id="serviceCount">0</div>
          <div class="subtext" id="servicePeriod">All Time</div>
        </div>
      </div>

      <div class="chart-container">
        <h3>Donation Type Breakdown</h3>
        <canvas id="pieChart"></canvas>
      </div>
    </div>

    <div id="transactionsPage" style="display:none;">
      <div class="toolbar">
        <div class="input-group">
          <select id="yearSelectTrans" aria-label="Select year"></select>
          <select id="monthSelectTrans" aria-label="Select month">
            <option value="">All Months</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          <button onclick="applyTransactionFilters()" class="primary">
            <i class="fas fa-filter"></i> Apply
          </button>
        </div>
        <input type="text" id="searchInput" class="search-input" placeholder="Search transactions...">
      </div>
      <table id="donationsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount (RM)</th>
            <th>Type</th>
            <th>Attended</th>
            <th>Counters</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyXVG_LdMJlexPz29jEFXTgOYjffgfJO8GbPjtMfFUMOOagFheVsCWAwp5kfueRbhtl/exec";
    let allDonations = [];
    let filteredDonations = [];

    function applyFilters() {
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      filteredDonations = allDonations.filter(d => {
        const matchesYear = !year || d.date.getFullYear() == year;
        const matchesMonth = !month || (d.date.getMonth() + 1).toString().padStart(2, '0') === month;
        return matchesYear && matchesMonth;
      });
      updateSummaryCards(filteredDonations);
      updatePieChart(filteredDonations);
    }

    function applyTransactionFilters() {
      const year = document.getElementById('yearSelectTrans').value;
      const month = document.getElementById('monthSelectTrans').value;
      filteredDonations = allDonations.filter(d => {
        const matchesYear = !year || d.date.getFullYear() == year;
        const matchesMonth = !month || (d.date.getMonth() + 1).toString().padStart(2, '0') === month;
        return matchesYear && matchesMonth;
      });
      updateRecentDonations(filteredDonations);
    }

    function updateSummaryCards(donations) {
      const attendedTotal = donations.filter(d => d.envelope === 'Yes').length;
      document.getElementById('attendanceCount').textContent = attendedTotal;
      const total = donations.reduce((sum, d) => sum + d.amount, 0);
      document.getElementById('totalOfferings').textContent = `RM${total.toFixed(2)}`;
      const avg = donations.length > 0 ? total / donations.length : 0;
      document.getElementById('avgOffering').textContent = `RM${avg.toFixed(2)}`;
      document.getElementById('serviceCount').textContent = donations.length;
    }

    function updatePieChart(donations) {
      const typeData = {};
      donations.forEach(d => { typeData[d.type] = (typeData[d.type] || 0) + d.amount; });
      const ctx = document.getElementById('pieChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(typeData),
          datasets: [{ data: Object.values(typeData) }]
        }
      });
    }

    function updateRecentDonations(donations) {
      const tbody = document.querySelector('#donationsTable tbody');
      tbody.innerHTML = donations.map(d => `<tr>
        <td>${d.date.toLocaleDateString()}</td>
        <td>${d.amount.toFixed(2)}</td>
        <td>${d.type}</td>
        <td>${d.envelope === 'Yes' ? '✓' : '✗'}</td>
        <td>${d.staff1}${d.staff2 ? ' & ' + d.staff2 : ''}</td>
        <td>${d.notes || ''}</td>
      </tr>`).join('');
    }

    window.onload = async function() {
      const res = await fetch(API_URL);
      const data = await res.json();
      allDonations = data.donations.map(d => ({
        ...d,
        date: new Date(d.date),
        amount: parseFloat(d.amount) || 0,
        envelope: d.envelope ? 'Yes' : 'No'
      }));
      filteredDonations = allDonations;
      updateSummaryCards(allDonations);
      updatePieChart(allDonations);
      updateRecentDonations(allDonations);
    }
  </script>
</body>
</html>
